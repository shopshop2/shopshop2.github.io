name: 'IndexNow'
on:
 schedule:
   - cron: '25 19 * * *'  # UTC 19:25 = KST 04:25
 workflow_dispatch:

jobs:
 submit-urls:
   runs-on: ubuntu-latest
   permissions:
     contents: read
   steps:
     - name: Debug Info
       run: |
         echo "Time Info:"
         echo "  UTC: $(date -u)"
         echo "  KST: $(TZ='Asia/Seoul' date)"

     - name: Checkout repository
       uses: actions/checkout@v4
       with:
         fetch-depth: 0

     - name: Get changed files and submit URLs
       run: |
         echo "üîç Finding files modified in last 24 hours..."
         CHANGED_FILES=$(find _posts/ -name "*.md" -mtime -1 -type f)
         
         if [ ! -z "$CHANGED_FILES" ]; then
           # Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò Í≥ÑÏÇ∞
           FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
           echo "üìÇ Found $FILE_COUNT files modified in last 24 hours"
           
           echo "üìã Creating URL list for IndexNow submission..."
           URL_LIST="["
           declare -A seen_urls
           URL_COUNT=0
           
           for file in $CHANGED_FILES; do
             FILENAME=$(basename "$file")
             URL_PATH=$(echo "$FILENAME" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2}-//' | sed 's/--/-/g' | sed 's/\.md$//' | sed 's/-$//')
             URL="https://guidekey.github.io/shopping/$URL_PATH/"
             
             if [ -z "${seen_urls[$URL]}" ]; then
               seen_urls[$URL]=1
               URL_LIST="$URL_LIST\"$URL\","
               ((URL_COUNT++))
               echo "‚ûï Adding URL ($URL_COUNT/$FILE_COUNT): $URL"
             fi
           done
           
           URL_LIST="${URL_LIST%,}]"
           
           echo "üì§ Submitting $URL_COUNT URLs to search engines..."
           response=$(curl -s -w "\nHTTP Status: %{http_code}" -X POST "https://api.indexnow.org/indexnow" \
           -H "Content-Type: application/json" \
           -d "{
             \"host\": \"guidekey.github.io\",
             \"key\": \"${{ secrets.INDEXNOW_KEY }}\",
             \"urlList\": $URL_LIST,
             \"keyLocation\": \"https://guidekey.github.io/${{ secrets.INDEXNOW_KEY }}.txt\"
           }")
           
           echo "üì¨ IndexNow API Response:"
           echo "$response"
           
           if echo "$response" | grep -q "HTTP Status: \(200\|202\)"; then
             echo "‚úÖ Successfully submitted $URL_COUNT URLs to search engines!"
           else
             echo "‚ùå Error submitting URLs"
             exit 1
           fi
         else
           echo "‚ÑπÔ∏è No files modified in the last 24 hours"
         fi

     - name: Report status
       if: always()
       run: |
         if [ "${{ job.status }}" = "success" ]; then
           echo "‚úÖ IndexNow submission completed successfully"
         else
           echo "‚ùå IndexNow submission failed"
         fi
         echo "Workflow completed at: $(date)"
