name: 'IND'
on:
 schedule:
   - cron: '25 19 * * *'  # UTC 19:25 = KST 04:25
 workflow_dispatch:
jobs:
 submit-urls:
   runs-on: ubuntu-latest
   permissions:
     contents: read
   steps:
     - name: Debug Info
       run: |
         echo "GitHub Context:"
         echo "  Repository: ${{ github.repository }}"
         echo "  Ref: ${{ github.ref }}"
         echo "  Event: ${{ github.event_name }}"
         echo "Time Info:"
         echo "  UTC: $(date -u)"
         echo "  KST: $(TZ='Asia/Seoul' date)"
     - name: Checkout repository
       uses: actions/checkout@v4
       with:
         fetch-depth: 0
     - name: Install Python
       uses: actions/setup-python@v4
       with:
         python-version: '3.x'
     - name: Get changed files and submit URLs
       run: |
         echo "Checking recent commits:"
         git log --since="24 hours ago" --name-only --pretty=format:"%h - %an, %ar : %s"
         
         # Python script to handle URL conversion
         python3 - <<EOF
         import os
         import subprocess
         import json
         import urllib.parse
         
         def decode_url_path(path):
             # URL 디코딩
             try:
                 decoded = urllib.parse.unquote(path)
                 # 파일명에서 날짜 제거 (YYYY-MM-DD-)
                 if decoded.startswith('_posts/'):
                     decoded = decoded[len('_posts/'):].split('.md')[0]
                 if decoded.startswith('2024-03-'):
                     decoded = decoded[11:]
                 return decoded
             except Exception as e:
                 print(f"Error decoding path: {e}")
                 return path
         
         # Get changed files from git log
         cmd = "git log --since='24 hours ago' --name-only --pretty=format:"
         changed_files = subprocess.check_output(cmd, shell=True).decode('utf-8').strip().split('\n')
         
         # Filter markdown files from _posts directory
         md_files = [f for f in changed_files if f.startswith('_posts/') and f.endswith('.md')]
         
         if md_files:
             url_list = []
             seen_urls = set()
             
             for file in md_files:
                 # URL 디코딩 및 경로 처리
                 decoded_path = decode_url_path(file)
                 # 중복 하이픈 제거 및 끝의 하이픈 제거
                 cleaned_path = '-'.join(filter(None, decoded_path.split('-')))
                 
                 # URL 생성
                 url = f"https://shopshop2.github.io/shopping/{cleaned_path}/"
                 
                 if url not in seen_urls:
                     seen_urls.add(url)
                     url_list.append(url)
                     print(f"Processing: {url}")
             
             # API 요청 데이터 준비
             data = {
                 "host": "shopshop2.github.io",
                 "key": "87ae650ca3ec4b2daec3bee8fa7ac2e3",
                 "urlList": url_list,
                 "keyLocation": "https://shopshop2.github.io/87ae650ca3ec4b2daec3bee8fa7ac2e3.txt"
             }
             
             # JSON 데이터 저장
             with open('/tmp/indexnow_data.json', 'w', encoding='utf-8') as f:
                 json.dump(data, f, ensure_ascii=False, indent=2)
             
             print("URL List prepared successfully")
         else:
             print("No markdown files found in _posts directory in the last 24 hours")
             exit(0)
         EOF
         
         if [ -f "/tmp/indexnow_data.json" ]; then
           response=$(curl -s -w "\nHTTP Status: %{http_code}" -X POST "https://api.indexnow.org/indexnow" \
             -H "Content-Type: application/json" \
             -d @/tmp/indexnow_data.json)
           
           echo "IndexNow API Response:"
           echo "$response"
           
           if echo "$response" | grep -q "HTTP Status: 200"; then
             echo "URLs successfully submitted to search engines!"
           else
             echo "Error submitting URLs. Please check the response above."
             exit 1
           fi
         fi
     - name: Report status
       if: always()
       run: |
         if [ "${{ job.status }}" = "success" ]; then
           echo "✅ IndexNow submission completed successfully"
         else
           echo "❌ IndexNow submission failed"
         fi
         echo "Workflow completed at: $(date)"
